<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Chat</title>
</head>
<body>
  <button id="connectBtn">Connect</button>
  <div id="usercount">Number of users connected:</div>
  <ul id="messages"></ul>

  <script>
    // Calculate the result of a given expression
    function calculate(expression) {
      try {
        // Evaluate the expression and return the result
        return Function(`return ${expression}`)();
      } catch (error) {
        console.error(`Error calculating expression: ${expression}`, error);
        return null;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const messages = document.getElementById('messages');
      const userCount = document.getElementById('usercount');
      const connectBtn = document.getElementById('connectBtn');

      let ws;
      let clientId;
      let connected = false;

      connectBtn.addEventListener('click', () => {
        if (!connected) {
          ws = new WebSocket(`ws://${location.host}`);
          setupWebSocketListeners();
          connected = true;
          connectBtn.textContent = 'Disconnect';
        } else {
          ws.close();
          connected = false;
          connectBtn.textContent = 'Connect';
        }
      });

      function setupWebSocketListeners() {
        ws.addEventListener('message', (event) => {
          const message = event.data;
          if (isValidJSON(message)) {
            const data = JSON.parse(message);
            if (data.type === 'usercount') {
              userCount.textContent = `Antal brugere: ${data.count}`;
            } else {
              handleProblems(data);
            }
          } else {
            clientId = parseInt(message.split(': ')[1]);
            const li = document.createElement('li');
            li.textContent = message;
            messages.appendChild(li);
          }
        });

        ws.addEventListener('close', () => {
          connected = false;
          connectBtn.textContent = 'Connect';
          userCount.textContent = 'Number of users connected: 0';
        });
      }

      function handleProblems(group) {
        group.forEach((item) => {
          const answer = calculate(item.problem);
          ws.send(JSON.stringify({
            type: 'answer',
            clientId: clientId,
            problemIndex: item.index,
            answer: answer
          }));

          const li = document.createElement('li');
          li.textContent = `Problem ${item.index}: ${item.problem} = ${answer}`;
          messages.appendChild(li);
        });
      }

      function isValidJSON(message) {
        try {
          JSON.parse(message);
          return true;
        } catch (error) {
          console.error(error);
          return false;
        }
      }
    });
  </script>
</body>
</html>
