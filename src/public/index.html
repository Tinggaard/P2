<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Chat</title>
</head>
<body>
  <div id="usercount">Number of users connected: 0</div>
  <ul id="messages"></ul>

  <script>
    // Calculate the result of a given expression
    function calculate(expression) {
      try {
        // Evaluate the expression and return the result
        return Function(`return ${expression}`)();
      } catch (error) {
        console.error(`Error calculating expression: ${expression}`, error);
        return null;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const messages = document.getElementById('messages'); 
      const userCount = document.getElementById('usercount');
      const ws = new WebSocket(`ws://${location.host}`);

      let clientId;
      ws.addEventListener('message', (event) => {
        const message = event.data;
        if (isValidJSON(message)) {
          const data = JSON.parse(message);
          if (data.type === 'usercount') {
            userCount.textContent = `Antal brugere: ${data.count}`;
          } else {
            const group = data;
            group.forEach((item) => {
              // Calculate the answer
              const answer = calculate(item.problem);

              // Send the answer back to the server
              ws.send(JSON.stringify({
                type: 'answer',
                clientId: clientId,
                problemIndex: item.index,
                answer: answer
              }));

              // Create a new li for each problem and add it to the list of messages
              const li = document.createElement('li');
              li.textContent = `Problem ${item.index}: ${item.problem} = ${answer}`;
              messages.appendChild(li);
            });
          }
        } else {
          clientId = parseInt(message.split(': ')[1]);
          const li = document.createElement('li');
          li.textContent = message;
          messages.appendChild(li);
        }
      });

      // Validate JSON
      function isValidJSON(message) {
        try {
          JSON.parse(message);
          return true;
        } catch (error) {
          console.error(error);
          return false;
        }
      }
    });
  </script>
</body>
</html>
